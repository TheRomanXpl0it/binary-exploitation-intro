/*
 * Authors:
 * + Andrea Fioraldi <andreafioraldi@gmail.com>
 * + Pietro Borrello <pietro.borrello95@gmail.com>
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define BANNER "\n    \xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84    \xe2\x96\x84  \xe2\x96\x88   \xe2\x96\x84     \xe2\x96\x84\xe2\x96\x80  \xe2\x96\x88\xe2\x96\x88   \xe2\x96\x88\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84     \xe2\x96\x84\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88  \xe2\x96\x88\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84 \xe2\x96\x84\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88\xe2\x96\x84   \xe2\x96\x84\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88\xe2\x96\x84   \n   \xe2\x96\x88     \xe2\x96\x80\xe2\x96\x84 \xe2\x96\x88   \xe2\x96\x88    \xe2\x96\x88  \xe2\x96\x84\xe2\x96\x80    \xe2\x96\x88 \xe2\x96\x88  \xe2\x96\x88  \xe2\x96\x84\xe2\x96\x80     \xe2\x96\x88\xe2\x96\x80   \xe2\x96\x80 \xe2\x96\x88  \xe2\x96\x84\xe2\x96\x80 \xe2\x96\x88\xe2\x96\x80   \xe2\x96\x80  \xe2\x96\x88\xe2\x96\x80   \xe2\x96\x80  \n \xe2\x96\x84  \xe2\x96\x80\xe2\x96\x80\xe2\x96\x80\xe2\x96\x80\xe2\x96\x84   \xe2\x96\x88\xe2\x96\x88\xe2\x96\x80\xe2\x96\x80\xe2\x96\x88 \xe2\x96\x88   \xe2\x96\x88 \xe2\x96\x88 \xe2\x96\x80\xe2\x96\x84  \xe2\x96\x88\xe2\x96\x84\xe2\x96\x84\xe2\x96\x88 \xe2\x96\x88\xe2\x96\x80\xe2\x96\x80\xe2\x96\x8c      \xe2\x96\x88\xe2\x96\x80\xe2\x96\x80    \xe2\x96\x88\xe2\x96\x80\xe2\x96\x80\xe2\x96\x8c  \xe2\x96\x88\xe2\x96\x88\xe2\x96\x84\xe2\x96\x84    \xe2\x96\x88\xe2\x96\x88\xe2\x96\x84\xe2\x96\x84    \n  \xe2\x96\x80\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x84\xe2\x96\x80    \xe2\x96\x88   \xe2\x96\x88 \xe2\x96\x88   \xe2\x96\x88 \xe2\x96\x88   \xe2\x96\x88 \xe2\x96\x88  \xe2\x96\x88 \xe2\x96\x88  \xe2\x96\x88      \xe2\x96\x88      \xe2\x96\x88  \xe2\x96\x88  \xe2\x96\x88\xe2\x96\x84   \xe2\x96\x84\xe2\x96\x80 \xe2\x96\x88\xe2\x96\x84   \xe2\x96\x84\xe2\x96\x80 \n               \xe2\x96\x88  \xe2\x96\x88\xe2\x96\x84 \xe2\x96\x84\xe2\x96\x88  \xe2\x96\x88\xe2\x96\x88\xe2\x96\x88     \xe2\x96\x88   \xe2\x96\x88        \xe2\x96\x88       \xe2\x96\x88   \xe2\x96\x80\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88\xe2\x96\x80   \xe2\x96\x80\xe2\x96\x88\xe2\x96\x88\xe2\x96\x88\xe2\x96\x80   \n              \xe2\x96\x80    \xe2\x96\x80\xe2\x96\x80\xe2\x96\x80          \xe2\x96\x88   \xe2\x96\x80          \xe2\x96\x80     \xe2\x96\x80                    \n                               \xe2\x96\x80                                          \n"

struct user_t
{
    char* name;
    char* password;
};
typedef struct user_t user_t;

user_t slots[10];

char *rand_password()
{

    static char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";        
    char *pass = malloc(120);
        
    int i;
    for (i = 0; i < 119; ++i) {            
        int key = rand() % (int)(sizeof(charset) -1);
        pass[i] = charset[key];
    }

    pass[119] = 0;

    return pass;
}

void add_user(int idx)
{
    slots[idx].name = malloc(120);
    printf("Enter the name for user #%d: ", idx);
    fgets(slots[idx].name, 120, stdin);
    
    slots[idx].password = rand_password();
    printf("User #%d created.\n", idx);
}

void remove_user(int idx)
{
    free(slots[idx].name);
    free(slots[idx].password);
    
    printf("User #%d removed\n", idx);
}

void print_user_name(int idx)
{
    if(idx < 0 || idx >= 10)
        return;
    
    printf("User #%d name is %s\n", idx, slots[idx].name);
}

void login(int idx)
{
    if(idx < 0 || idx >= 10)
        return;
    
    char pass[120];
    printf("Enter the password for user #%d: ", idx);
    fgets(pass, 120, stdin);
    
    if(slots[idx].password == NULL) {
        printf("User #%d invalid\n", idx);
    }
    else if(strcmp(pass, slots[idx].password)) {
        printf("Wrong password!\n");
    }
    else {
        printf("You are logged in.\n");
        system("/bin/sh");
    }
}

void menu()
{
    printf("\n Syntax: [command] [user id]\n\n");
    printf("  Avaiable commands:\n");
    printf("    0. Add an user\n");
    printf("    1. Remove an user\n");
    printf("    2. Print an user's name\n");
    printf("    3. Login\n");
    printf("    4. Exit\n\n >> ");
}

int main()
{
    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);    

    int cmd;
    int idx;
    char tmp[50];
    
    srand(time(0));
    
    printf(BANNER);
    
    while(1) {
        menu();
        fgets(tmp, 50, stdin);
        sscanf(tmp, "%d %d\n", &cmd, &idx);
        
        switch(cmd) {
        case 0:
            add_user(idx);
            break;
        case 1:
            remove_user(idx);
            break;
        case 2:
            print_user_name(idx);
            break;
        case 3:
            login(idx);
            break;
        case 4:
            return 0;
        }
    }
}


