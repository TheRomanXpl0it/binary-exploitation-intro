/*
 * Authors:
 * + Andrea Fioraldi <andreafioraldi@gmail.com>
 * + Pietro Borrello <pietro.borrello95@gmail.com>
 */

// Termbird: any resemblance to real events and/or to real persons, living or dead, is purely coincidental (we are joking hahahaha)

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define BANNER "\n   \xe2\x95\xa6 \xe2\x95\xa6\xe2\x94\x8c\xe2\x94\x80\xe2\x94\x90\xe2\x94\xac  \xe2\x94\x8c\xe2\x94\x80\xe2\x94\x90\xe2\x94\x8c\xe2\x94\x80\xe2\x94\x90\xe2\x94\x8c\xe2\x94\xac\xe2\x94\x90\xe2\x94\x8c\xe2\x94\x80\xe2\x94\x90  \xe2\x94\x8c\xe2\x94\xac\xe2\x94\x90\xe2\x94\x8c\xe2\x94\x80\xe2\x94\x90  \xe2\x95\x94\xe2\x95\xa6\xe2\x95\x97\xe2\x95\x94\xe2\x95\x90\xe2\x95\x97\xe2\x95\x94\xe2\x95\x90\xe2\x95\x97  \xe2\x95\x94\xe2\x95\x90\xe2\x95\x97\xe2\x95\x94\xe2\x95\x90\xe2\x95\x97\xe2\x95\x94\xe2\x95\x97\xe2\x95\x94  \xe2\x95\x94\xe2\x95\x90\xe2\x95\x97\xe2\x95\x94\xe2\x95\xa6\xe2\x95\x97\xe2\x95\x94\xe2\x95\x90\xe2\x95\x97\n   \xe2\x95\x91\xe2\x95\x91\xe2\x95\x91\xe2\x94\x9c\xe2\x94\xa4 \xe2\x94\x82  \xe2\x94\x82  \xe2\x94\x82 \xe2\x94\x82\xe2\x94\x82\xe2\x94\x82\xe2\x94\x82\xe2\x94\x9c\xe2\x94\xa4    \xe2\x94\x82 \xe2\x94\x82 \xe2\x94\x82   \xe2\x95\x91\xe2\x95\x91\xe2\x95\x91\xe2\x95\xa3 \xe2\x95\xa0\xe2\x95\xa3   \xe2\x95\x91  \xe2\x95\x91 \xe2\x95\x91\xe2\x95\x91\xe2\x95\x91\xe2\x95\x91  \xe2\x95\x91   \xe2\x95\x91 \xe2\x95\xa0\xe2\x95\xa3 \n   \xe2\x95\x9a\xe2\x95\xa9\xe2\x95\x9d\xe2\x94\x94\xe2\x94\x80\xe2\x94\x98\xe2\x94\xb4\xe2\x94\x80\xe2\x94\x98\xe2\x94\x94\xe2\x94\x80\xe2\x94\x98\xe2\x94\x94\xe2\x94\x80\xe2\x94\x98\xe2\x94\xb4 \xe2\x94\xb4\xe2\x94\x94\xe2\x94\x80\xe2\x94\x98   \xe2\x94\xb4 \xe2\x94\x94\xe2\x94\x80\xe2\x94\x98  \xe2\x95\x90\xe2\x95\xa9\xe2\x95\x9d\xe2\x95\x9a\xe2\x95\x90\xe2\x95\x9d\xe2\x95\x9a    \xe2\x95\x9a\xe2\x95\x90\xe2\x95\x9d\xe2\x95\x9a\xe2\x95\x90\xe2\x95\x9d\xe2\x95\x9d\xe2\x95\x9a\xe2\x95\x9d  \xe2\x95\x9a\xe2\x95\x90\xe2\x95\x9d \xe2\x95\xa9 \xe2\x95\x9a  \n"

#define SERVICES_NUM 4
#define TEAMS_NUM 10
#define FLAG_LEN 14

struct service_t
{
    char* name;
    char* flag;
    int points;
};
typedef struct service_t service_t;

struct team_t
{
    char* name;
    int score;
};
typedef struct team_t team_t;

service_t services[SERVICES_NUM];
team_t teams[TEAMS_NUM];

char* rand_flag()
{
    static char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";        
    char* flag = malloc(FLAG_LEN);
    
    flag[0] = 'o';
    flag[1] = 'o';
    flag[2] = 'o';
    flag[3] = '{';
    
    int i;
    for (i = 4; i < 12; ++i) {            
        int key = rand() % (int)(sizeof(charset) -1);
        flag[i] = charset[key];
    }

    flag[12] = '}';
    flag[13] = 0;
    
    return flag;
}


void add_team(int idx)
{
    if(teams[idx].name) {
        printf(" Ehi! You can't overwrite team %s, all the teams must play!\n", teams[idx].name);
        return;
    }
    
    unsigned len;
    char tmp[50];
    
    printf("Enter the size of the team #%d name: ", idx);
    fgets(tmp, 50, stdin);
    sscanf(tmp, "%u", &len);
    
    if(len > 1000) {
        printf(" Too long.\n");
        return;
    }
    
    teams[idx].name = malloc(len);
    printf("Enter the name for team #%d: ", idx);
    read(0, teams[idx].name, len);
    teams[idx].score = 0;
    
    printf("Team #%d created.\n", idx);
}

void remove_team(int idx)
{
    free(teams[idx].name);
    
    teams[idx].name = NULL;
    teams[idx].score = 0;
    
    printf("Team #%d removed\n", idx);
}

void submit_flag(int idx)
{
    char* flag = malloc(FLAG_LEN);
    int i;
    
    if(strcmp(teams[idx].name, "termbird") == 0) {
        printf(" Hey! You are Termbird, you do not have flags to submit!\n");
        return;
    }
    
    printf("Enter the flag: ");
    fgets(flag, 114, stdin);
    
    for(i = 0; i < SERVICES_NUM; ++i) {
        if(strcmp(services[i].flag, flag) == 0) {
            teams[idx].score += services[i].points;
            printf("Good flag for service %s! Score updated.\n", services[i].name);
            return;
        }
    }
    
    printf("Invalid flag!\n");
}

void print_services()
{
    int i;
    
    printf("\n Services:\n\n");
    for(i = 0; i < SERVICES_NUM; ++i) {
        printf("   - %s, with points %d\n", services[i].name, services[i].points);
    }
    printf("\n");
}

void scoreboard()
{
    int i, j, loc_max;
    team_t* board[TEAMS_NUM];
    team_t* tmp;
    int count = 0;
    
    for(i = 0; i < TEAMS_NUM; ++i) {
        if(teams[i].name) {
            board[count] = &teams[i];
            ++count;
        }
    }
    
    for(i = 0; i < count-1; ++i) {
        loc_max = i;
        
        for (j = i+1; j < count; ++j) {
        	if (board[j]->score > board[loc_max]->score)
        	    loc_max = j;
        }

        tmp = board[loc_max];
        board[loc_max] = board[i];
        board[i] = tmp;
    }
    
    printf("\n Scoreboard:\n\n");
    for(i = 0; i < count; ++i) {
        printf("   [%d] %s, with score %d\n", i, board[i]->name, board[i]->score);
    }
    printf("\n Oh no! Termbird did it again!\n\n");
}

void setup()
{
    teams[0].name = "mhackeroni";
    teams[0].score = 999999;
    teams[1].name = "termbird";
    teams[1].score = -1;
    
    services[0].name = "oooeditor";
    services[0].flag = rand_flag();
    services[0].points = 100;
    
    services[1].name = "doublethink";
    services[1].flag = rand_flag();
    services[1].points = 200;
    
    services[2].name = "pointless";
    services[2].flag = rand_flag();
    services[2].points = 120;
    
    services[3].name = "itsame";
    services[3].flag = rand_flag();
    services[3].points = 123;
}

void menu()
{
    printf("\n Syntax: [command]\n\n");
    printf("  Avaiable commands:\n");
    printf("    0. Add a team\n");
    printf("    1. Remove a team\n");
    printf("    2. Submit a flag\n");
    printf("    3. Show services\n");
    printf("    4. Show scoreboard\n");
    printf("    5. Exit\n\n >> ");
}

int main()
{
    setvbuf(stdin, 0, 2, 0);
	setvbuf(stdout, 0, 2, 0);    
    
    int cmd;
    int idx;
    char tmp[50];
    
    setup();
    
    printf(BANNER);
    printf("\n This is our leet flag submission service.\n");
    
    while(1) {
        menu();
        fgets(tmp, 50, stdin);
        sscanf(tmp, "%d", &cmd);
        
        switch(cmd) {
        case 0:
            printf(" Enter the target index:\n >> ");
            fgets(tmp, 50, stdin);
            sscanf(tmp, "%d", &idx);
            add_team(idx);
            break;
        case 1:
            printf(" Enter the target index:\n >> ");
            fgets(tmp, 50, stdin);
            sscanf(tmp, "%d", &idx);
            remove_team(idx);
            break;
        case 2:
            printf(" Enter the target index:\n >> ");
            fgets(tmp, 50, stdin);
            sscanf(tmp, "%d", &idx);
            submit_flag(idx);
            break;
        case 3:
            print_services();
            break;
        case 4:
            scoreboard();
            break;
        case 5:
            return 0;
        }
    }
}


